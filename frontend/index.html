<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hindsight Recall</title>
</head>
<body>
  <h1>Hindsight Recall <button id="openPrefs" style="float:right;font-size:12px;">Preferences</button></h1>
  <div id="pageMain">
  <section>
  <h2>Capture Status</h2>
  <div id="status">Waiting for first capture...</div>
  <div id="backendInfo" style="margin-top:4px;font-size:12px;color:#333;display:none;"></div>
  <div id="staleWarning" style="display:none;color:#b00;font-weight:bold;margin-top:4px;">Status stale: no recent capture activity.</div>
    <div style="margin:6px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <button id="btnStart">Start Capture</button>
      <button id="btnStop">Stop Capture</button>
      <button id="btnPid">Show PID</button>
      <button id="btnPurge" title="Delete all stored capture artifacts (keeps key)">Purge Data</button>
      <span id="pidDisplay" style="font-size:12px;color:#444;"></span>
      <span id="errorDisplay" style="font-size:12px;color:#b00;font-weight:bold;"></span>
    </div>
    <pre id="raw" style="background:#111;color:#9f9;padding:8px;max-height:200px;overflow:auto;"></pre>
  </section>
  <section style="margin-top:18px;">
    <h2>Python Logs <span style="font-size:12px;font-weight:normal;">(live)</span></h2>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:4px;">
      <label style="font-size:12px;">Min Level
        <select id="pyLogFilter" style="margin-left:4px;">
          <option value="DEBUG">DEBUG</option>
          <option value="INFO" selected>INFO</option>
          <option value="WARNING">WARNING</option>
          <option value="ERROR">ERROR</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
      </label>
      <button id="pyLogClear" style="font-size:12px;">Clear</button>
      <span id="pyLogStats" style="font-size:11px;color:#555;"></span>
    </div>
    <pre id="pyLogView" style="background:#000;color:#eee;padding:8px;max-height:260px;overflow:auto;font-size:12px;line-height:1.3;border:1px solid #333;"></pre>
  </section>
  </div>
  <div id="pagePrefs" style="display:none;max-width:640px;">
    <h2 style="margin-top:0;">Preferences <button id="closePrefs" style="float:right;font-size:12px;">Close</button></h2>
    <div style="border:1px solid #ccc;padding:10px;border-radius:4px;background:#fafafa;">
      <h3>Capture</h3>
      <label style="display:block;margin:4px 0;">
        <input type="checkbox" id="autostartToggle" /> Run capture on login (background)
      </label>
      <label style="display:block;margin:4px 0;">Interval (s)
        <input type="number" id="pInterval" min="1" style="width:90px;" />
      </label>
      <label style="display:block;margin:4px 0;">Startup Delay (s)
        <input type="number" id="pDelay" min="0" style="width:90px;" />
      </label>
      <div style="margin:6px 0;">
        <button id="validateBtn" title="Validate autostart entry">Validate Autostart</button>
      </div>
      <div id="validation" style="display:none;margin:8px 0;padding:8px;border:1px solid #666;background:#222;color:#ddd;">
        <strong>Autostart Validation</strong>
        <div id="validationBody" style="font-size:12px;white-space:pre-wrap;margin-top:4px;"></div>
      </div>
      <h3 style="margin-top:14px;">Logging</h3>
      <label style="display:block;margin:4px 0;">Log Timezone
        <select id="pLogTz" style="width:140px;">
          <option value="LOCAL">LOCAL (system)</option>
          <option value="UTC">UTC</option>
          <option value="-0400">-0400 (example)</option>
          <option value="+0000">+0000</option>
        </select>
      </label>
      <label style="display:block;margin:4px 0;">Python Log Level
        <select id="pLogLevel" style="width:140px;">
          <option value="DEBUG">DEBUG</option>
          <option value="INFO" selected>INFO</option>
          <option value="WARNING">WARNING</option>
          <option value="ERROR">ERROR</option>
          <option value="CRITICAL">CRITICAL</option>
        </select>
      </label>
      <label style="display:block;margin:4px 0;">
        <input type="checkbox" id="pDstAdjust" /> Add 1 hour daylight saving adjustment
      </label>
      <div style="font-size:11px;color:#555;margin-bottom:8px;">You can enter a custom offset like +0530 or -0700 by typing it directly.</div>
      <button id="saveAllPrefs">Save Preferences</button>
      <span id="saveAllMsg" style="font-size:12px;margin-left:8px;color:#444;"></span>
    </div>
    <div style="border:1px solid #ccc;padding:10px;border-radius:4px;background:#f5f5f5;margin-top:14px;">
      <h3>Security</h3>
      <div style="font-size:12px;color:#555;margin-bottom:6px;">Change your passphrase or switch to a numeric PIN (4–8 digits). Provide your current passphrase OR recovery token.</div>
      <label style="display:block;margin:4px 0;">Current Passphrase or Recovery Token
        <input type="password" id="secCurrent" style="width:100%;" placeholder="Enter current passphrase or recovery token" />
      </label>
      <label style="display:block;margin:4px 0;">New Passphrase or PIN
        <input type="password" id="secNew" style="width:100%;" placeholder="New passphrase or 4-8 digit PIN" />
      </label>
      <label style="display:block;margin:4px 0;">Confirm New
        <input type="password" id="secNew2" style="width:100%;" placeholder="Re-enter new secret" />
      </label>
      <label style="display:block;margin:4px 0;">
        <input type="checkbox" id="secUseRecovery" /> Use recovery token (instead of current passphrase)
      </label>
      <button id="secChangeBtn">Change Secret</button>
      <span id="secMsg" style="font-size:12px;margin-left:8px;color:#444;"></span>
      <div style="font-size:11px;color:#555;margin-top:8px;">Requirements: Passphrase ≥12 chars incl upper/lower/digit/special (no spaces) OR PIN 4–8 digits. Recovery token path requires that a recovery token exists.</div>
    </div>
  </div>
  <script>
    (function init() {
      if (!window.hindsight) { return setTimeout(init, 100); }
      const raw = document.getElementById('raw');
      raw.textContent += '\n[ui] Hindsight API ready';
      function initAutostartCheckbox() {
        const cb = document.getElementById('autostartToggle'); if (!cb) return;
        window.hindsight.getAutostart().then(enabled => { cb.checked = !!enabled; }).catch(e=>{raw.textContent += '\n[ui] autostart get failed: '+e;});
        cb.addEventListener('change', (e) => {
          window.hindsight.setAutostart(e.target.checked).then(() => { if (e.target.checked) doValidate(); }).catch(err=>{raw.textContent += '\n[ui] setAutostart error: '+err;});
        });
      }
      window.hindsight.getPrefs().then(p => {
        const pInt = document.getElementById('pInterval');
        const pDel = document.getElementById('pDelay');
        const pTz = document.getElementById('pLogTz');
        const pLevel = document.getElementById('pLogLevel');
        if (pInt) pInt.value = p.interval || 5;
        if (pDel) pDel.value = p.delaySeconds || 0;
        if (pTz) {
          if (p.logTimezone && !Array.from(pTz.options).some(o=>o.value===p.logTimezone)) {
            const opt = document.createElement('option'); opt.value = p.logTimezone; opt.textContent = p.logTimezone + ' (custom)'; pTz.appendChild(opt);
          }
          pTz.value = p.logTimezone || 'LOCAL';
        }
        if (pLevel && p.logLevel) { try { pLevel.value = p.logLevel; } catch(_) {} }
        const dstCb = document.getElementById('pDstAdjust'); if (dstCb) dstCb.checked = !!p.dstAdjust;
        initAutostartCheckbox();
      }).catch(e=>{raw.textContent += '\n[ui] prefs get failed: '+e;});
      function validateTz(value) {
        const v = (value||'').trim().toUpperCase();
        if (v === 'LOCAL' || v === 'UTC') return {ok:true, norm:v};
        if (/^[+-]\d{4}$/.test(v)) return {ok:true, norm:v};
        if (/^[+-]\d{2}:\d{2}$/.test(v)) return {ok:true, norm:v.replace(':','')};
        return {ok:false, norm:null};
      }
      const tzSel = document.getElementById('pLogTz');
      const saveBtn = document.getElementById('saveAllPrefs');
      const saveMsg = document.getElementById('saveAllMsg');
      function applyTzValidation() {
        const {ok, norm} = validateTz(tzSel.value);
        if (!ok) { tzSel.style.borderColor='#c00'; saveBtn.disabled=true; saveMsg.textContent='Invalid timezone.'; saveMsg.style.color='#c00'; }
        else { tzSel.style.borderColor=''; saveBtn.disabled=false; saveMsg.textContent=''; saveMsg.style.color='#444'; if (norm && norm!==tzSel.value) tzSel.value=norm; }
      }
      tzSel.addEventListener('input', applyTzValidation); tzSel.addEventListener('change', applyTzValidation); applyTzValidation();
      document.getElementById('saveAllPrefs').addEventListener('click', ()=>{
        const interval = parseInt(document.getElementById('pInterval').value,10) || 5;
        const delaySeconds = parseInt(document.getElementById('pDelay').value,10) || 0;
        const tzRaw = tzSel.value; const {ok, norm} = validateTz(tzRaw); if (!ok) { applyTzValidation(); return; }
        const logTimezone = norm; const dstAdjust = !!document.getElementById('pDstAdjust').checked;
        const logLevelSel = document.getElementById('pLogLevel'); const logLevel = logLevelSel ? logLevelSel.value : 'INFO';
        const msgEl = saveMsg; msgEl.textContent='Saving...'; msgEl.style.color='#444';
        window.hindsight.setPrefs({interval, delaySeconds, logTimezone, dstAdjust, logLevel}).then(()=>{ msgEl.textContent='Saved.'; }).catch(err=>{ msgEl.textContent='Error: '+err; msgEl.style.color='#c00'; });
      });
      // Status updates
      let lastStatusTime = null; let lastIntervalSeconds = 5; window.hindsight.getPrefs().then(p=>{ if (p && p.interval) lastIntervalSeconds = p.interval; }).catch(()=>{});
      let lastBackend = null; let lastSwitchReason = null; let lastSwitchLocalTs = null;
      window.hindsight.onStatus((s)=>{
        lastStatusTime = Date.now(); if (s.interval) lastIntervalSeconds = s.interval;
        const statusEl = document.getElementById('status'); let localStr = s.last_capture_utc; try { localStr = new Date(s.last_capture_utc).toLocaleString(); } catch(_) {}
        statusEl.textContent = `Last capture (local): ${localStr} | Window: ${s.window_title} | Count: ${s.capture_count}`;
        document.getElementById('raw').textContent = JSON.stringify(s,null,2);
        const errEl = document.getElementById('errorDisplay'); errEl.textContent = s.error ? ('Error: '+s.error) : '';
        const backendInfoEl = document.getElementById('backendInfo'); if (s.capture_backend || s.backend_switch_reason || lastSwitchReason) {
          backendInfoEl.style.display='block'; if (s.backend_switch_reason) { lastSwitchReason = s.backend_switch_reason; lastSwitchLocalTs = Date.now(); }
          const parts=[]; if (s.capture_backend) parts.push('Backend: '+s.capture_backend); if (lastSwitchReason) { let when=''; if (lastSwitchLocalTs) when=' at '+new Date(lastSwitchLocalTs).toLocaleTimeString(); parts.push('Last switch reason: '+lastSwitchReason+when); }
          backendInfoEl.textContent = parts.join(' | ');
        }
        if (s.capture_backend) lastBackend = s.capture_backend;
      });
      window.hindsight.onLog((msg)=>{ const raw = document.getElementById('raw'); raw.textContent += "\n[log] "+msg; });
      // Python log streaming
      (function pyLogInit(){
        const view = document.getElementById('pyLogView'); const sel = document.getElementById('pyLogFilter'); const clearBtn = document.getElementById('pyLogClear'); const stats = document.getElementById('pyLogStats');
        const order = {DEBUG:0, INFO:1, WARNING:2, ERROR:3, CRITICAL:4}; let counts={DEBUG:0,INFO:0,WARNING:0,ERROR:0,CRITICAL:0};
        function update(){ stats.textContent = `Shown≥${sel.value} D:${counts.DEBUG} I:${counts.INFO} W:${counts.WARNING} E:${counts.ERROR} C:${counts.CRITICAL}`; }
        clearBtn.addEventListener('click', ()=>{ view.textContent=''; counts={DEBUG:0,INFO:0,WARNING:0,ERROR:0,CRITICAL:0}; update(); });
        window.hindsight.onPyLog(pl=>{ if (!pl||!pl.line) return; const lvl=pl.level||'INFO'; counts[lvl]=(counts[lvl]||0)+1; if (order[lvl] >= order[sel.value]) { const line=pl.line.replace(/\x1b\[[0-9;]*m/g,''); view.textContent += (view.textContent?'\n':'')+line; if (view.scrollTop+view.clientHeight+40 >= view.scrollHeight) view.scrollTop=view.scrollHeight; } update(); });
        sel.addEventListener('change', ()=>{ /* future: rebuild if we keep ring buffer */ update(); }); update();
      })();
      // Buttons
      document.getElementById('btnStart').addEventListener('click', ()=>{ window.hindsight.captureStart(); setTimeout(refreshPid,700); });
      document.getElementById('btnStop').addEventListener('click', ()=>{ window.hindsight.captureStop().then(()=>setTimeout(refreshPid,700)); });
      document.getElementById('btnPid').addEventListener('click', refreshPid);
      document.getElementById('btnPurge').addEventListener('click', ()=>{ if (!confirm('Delete all stored capture data?')) return; window.hindsight.purgeData().then(r=>{ raw.textContent+='\n[ui] Purge removed '+(r.removed||0)+' items'; setTimeout(refreshPid,500); }).catch(e=>{ raw.textContent+='\n[ui] Purge error: '+e; }); });
      function refreshPid(){ window.hindsight.captureStatus().then(r=>{ document.getElementById('pidDisplay').textContent = r.pid ? ('PID: '+r.pid) : 'Not running'; }); }
      setInterval(refreshPid, 5000); refreshPid();
      document.getElementById('openPrefs').addEventListener('click', ()=>{ document.getElementById('pageMain').style.display='none'; document.getElementById('pagePrefs').style.display='block'; });
      document.getElementById('closePrefs').addEventListener('click', ()=>{ document.getElementById('pagePrefs').style.display='none'; document.getElementById('pageMain').style.display='block'; });
      function doValidate(){ const wrap=document.getElementById('validation'); const body=document.getElementById('validationBody'); wrap.style.display='block'; body.textContent='Validating...'; window.hindsight.validateAutostart().then(res=>{ if(!res.exists){ body.textContent='Autostart file not found.'; return;} let out='File: '+res.file+'\n'; if(res.exec) out+='Exec: '+res.exec+'\n'; if(!res.issues||!res.issues.length) out+='\nStatus: OK'; else out+='\nIssues:\n - '+res.issues.join('\n - '); body.textContent=out; }).catch(err=>{ body.textContent='Validation error: '+err; }); }
      document.getElementById('validateBtn').addEventListener('click', doValidate);
    })();
  </script>
</body>
</html>

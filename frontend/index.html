<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hindsight Recall</title>
  <style>
  /* Log level highlighting */
  .log-line { white-space: pre; font-family: monospace; display:block; padding:2px 6px; margin:0; }
  /* Low-priority / trace */
  .log-level-TRACE { color:#9aa; }
  /* Debug is muted gray */
  .log-level-DEBUG { color:#9a9a9a; }
  /* Normal informational */
  .log-level-INFO { color:#dcdcdc; }
  /* Warnings stand out in orange with subtle background */
  .log-level-WARNING { color:#ffb84d; background: rgba(255,184,77,0.04); }
  /* Errors in red */
  .log-level-ERROR { color:#ff6b6b; background: rgba(255,107,107,0.04); font-weight:600; }
  /* Critical/high severity: bold and stronger red, left accent */
  .log-level-CRITICAL, .log-level-CRIT { color:#ff3d3d; background: rgba(255,61,61,0.06); font-weight:700; border-left:4px solid rgba(255,61,61,0.12); padding-left:6px; }
  #pyLogView { font-family: monospace; }
  .collapseBtn { cursor:pointer; border:1px solid #888; background:#eee; color:#222; font-size:10px; width:18px; height:18px; line-height:16px; padding:0; text-align:center; border-radius:3px; }
  .prefHeader { display:flex; align-items:center; gap:6px; margin:0 0 6px 0; }
  .collapsibleHeader { display:flex; align-items:flex-end; gap:8px; flex-wrap:wrap; }
  .sectionBody { transition: height 0.15s ease, opacity 0.15s ease; }
  .collapsed { display:none !important; }
  </style>
</head>
<body>
  <h1>Hindsight Recall <button id="openPrefs" style="float:right;font-size:12px;">Preferences</button></h1>
  <div id="pageMain">
  <section>
  <h2>Capture Status</h2>
  <!-- Quick preferences removed; use Preferences page -->
  <!-- Validation moved to Preferences page -->
  <div id="status">Waiting for first capture...</div>
  <div id="backendInfo" style="margin-top:4px;font-size:12px;color:#333;display:none;"></div>
  <div id="staleWarning" style="display:none;color:#b00;font-weight:bold;margin-top:4px;">Status stale: no recent capture activity.</div>
    <div style="margin:6px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
      <button id="btnStart">Start Capture</button>
      <button id="btnStop">Stop Capture</button>
      <button id="btnPid">Show PID</button>
      <button id="btnPurge" title="Delete all stored capture artifacts (keeps key)">Purge Data</button>
      <span id="pidDisplay" style="font-size:12px;color:#444;"></span>
      <span id="errorDisplay" style="font-size:12px;color:#b00;font-weight:bold;"></span>
    </div>
  <!-- Raw status.json view removed -->
  </section>
  </div>
  <div id="pageLogs" style="display:none;max-width:1000px;">
    <h2 style="margin-top:0;">Logs <button id="closeLogs" style="float:right;font-size:12px;">Close</button></h2>
  <div id="logSettings" style="border:1px solid #ccc;background:#fff;padding:6px 10px 10px 10px;margin:4px 0 10px 0;border-radius:4px;">
    <div class="collapsibleHeader" style="justify-content:space-between;align-items:center;margin-bottom:6px;">
      <div style="display:flex;align-items:center;gap:6px;">
        <button class="collapseBtn" id="collapseLogSettings" data-target="logSettingsBody" title="Collapse/Expand">▾</button>
        <strong style="font-size:13px;">Logging Settings</strong>
      </div>
      <div style="font-size:11px;color:#666;">Adjust timezone / level & save</div>
    </div>
    <div id="logSettingsBody" style="display:flex;flex-wrap:wrap;gap:18px;align-items:flex-end;">
        <div style="font-size:12px;display:flex;flex-direction:column;">
          <label style="font-size:11px;margin-bottom:2px;">Log Timezone</label>
          <select id="pLogTz" style="width:140px;font-size:12px;"></select>
        </div>
        <div style="font-size:12px;display:flex;flex-direction:column;">
          <label style="font-size:11px;margin-bottom:2px;">DST +1h</label>
          <input type="checkbox" id="pDstAdjust" />
        </div>
        <div style="font-size:12px;display:flex;flex-direction:column;">
          <label style="font-size:11px;margin-bottom:2px;">Python Level</label>
          <select id="pLogLevel" style="width:120px;font-size:12px;">
            <option value="DEBUG">DEBUG</option>
            <option value="INFO" selected>INFO</option>
            <option value="WARNING">WARNING</option>
            <option value="ERROR">ERROR</option>
            <option value="CRITICAL">CRITICAL</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px;">
          <button id="saveLogPrefs" style="font-size:12px;">Save Logging</button>
          <span id="saveLogMsg" style="font-size:11px;color:#888;"></span>
        </div>
    </div>
  </div>
    <div style="display:flex;flex-wrap:wrap;gap:14px;align-items:center;margin:4px 0 8px 0;">
      <div style="font-size:12px;">Levels:
  <label style="margin-left:6px;font-weight:normal;"><input type="checkbox" class="lvChk" data-level="TRACE" checked /> TRACE</label>
  <label style="margin-left:6px;font-weight:normal;"><input type="checkbox" class="lvChk" data-level="DEBUG" checked /> DEBUG</label>
  <label style="margin-left:6px;font-weight:normal;"><input type="checkbox" class="lvChk" data-level="INFO" checked /> INFO</label>
  <label style="margin-left:6px;font-weight:normal;"><input type="checkbox" class="lvChk" data-level="WARNING" checked /> WARN</label>
  <label style="margin-left:6px;font-weight:normal;"><input type="checkbox" class="lvChk" data-level="ERROR" checked /> ERROR</label>
  <label style="margin-left:6px;font-weight:normal;"><input type="checkbox" class="lvChk" data-level="CRITICAL" checked /> CRIT</label>
      </div>
      <button id="pyLogClear" style="font-size:12px;">Clear</button>
  <button id="simLog" style="font-size:12px;">Simulate Logs</button>
      <span id="pyLogStats" style="font-size:11px;color:#555;"></span>
    </div>
  <div id="pyLogView" style="background:#000;color:#eee;padding:8px;max-height:480px;overflow:auto;font-size:12px;line-height:1.3;border:1px solid #333;"></div>
  </div>
  <div id="pagePrefs" style="display:none;max-width:640px;">
    <h2 style="margin-top:0;">Preferences <button id="closePrefs" style="float:right;font-size:12px;">Close</button></h2>
    <div style="border:1px solid #ccc;padding:10px;border-radius:4px;background:#fafafa;">
      <div class="prefHeader"><button class="collapseBtn" data-target="capturePrefsBody" id="collapseCapture" title="Collapse/Expand">▾</button><h3 style="margin:0;">Capture</h3></div>
      <div class="sectionBody" id="capturePrefsBody">
        <label style="display:block;margin:4px 0;">
          <input type="checkbox" id="autostartToggle" /> Run capture on login (background)
        </label>
        <label style="display:block;margin:4px 0;">Interval (s)
          <input type="number" id="pInterval" min="1" style="width:90px;" />
        </label>
        <label style="display:block;margin:4px 0;">Startup Delay (s)
          <input type="number" id="pDelay" min="0" style="width:90px;" />
        </label>
        <div style="margin:6px 0;">
          <button id="validateBtn" title="Validate autostart entry">Validate Autostart</button>
        </div>
        <div id="validation" style="display:none;margin:8px 0;padding:8px;border:1px solid #666;background:#222;color:#ddd;">
          <strong>Autostart Validation</strong>
          <div id="validationBody" style="font-size:12px;white-space:pre-wrap;margin-top:4px;"></div>
        </div>
        <!-- Logging section removed entirely from Preferences page -->
        <button id="saveAllPrefs">Save Preferences</button>
        <span id="saveAllMsg" style="font-size:12px;margin-left:8px;color:#444;"></span>
      </div>
    </div>
    <div style="border:1px solid #ccc;padding:10px;border-radius:4px;background:#f5f5f5;margin-top:14px;">
      <div class="prefHeader"><button class="collapseBtn" data-target="securityPrefsBody" id="collapseSecurity" title="Collapse/Expand">▾</button><h3 style="margin:0;">Security</h3></div>
      <div class="sectionBody" id="securityPrefsBody">
        <div style="font-size:12px;color:#555;margin-bottom:6px;">Change your passphrase or switch to a numeric PIN (4–8 digits). Provide your current passphrase OR recovery token.</div>
        <label style="display:block;margin:4px 0;">Current Passphrase or Recovery Token
          <input type="password" id="secCurrent" style="width:100%;" placeholder="Enter current passphrase or recovery token" />
        </label>
        <label style="display:block;margin:4px 0;">New Passphrase or PIN
          <input type="password" id="secNew" style="width:100%;" placeholder="New passphrase or 4-8 digit PIN" />
        </label>
        <label style="display:block;margin:4px 0;">Confirm New
          <input type="password" id="secNew2" style="width:100%;" placeholder="Re-enter new secret" />
        </label>
        <label style="display:block;margin:4px 0;">
          <input type="checkbox" id="secUseRecovery" /> Use recovery token (instead of current passphrase)
        </label>
        <button id="secChangeBtn">Change Secret</button>
        <span id="secMsg" style="font-size:12px;margin-left:8px;color:#444;"></span>
        <div style="font-size:11px;color:#555;margin-top:8px;">Requirements: Passphrase ≥12 chars incl upper/lower/digit/special (no spaces) OR PIN 4–8 digits. Recovery token path requires that a recovery token exists.</div>
      </div>
    </div>
  </div>
  <script>
    (function init() {
      if (!window.hindsight) {
        // Retry shortly until preload exposes API
        return setTimeout(init, 100);
      }
  const appendUi = (msg) => { try { console.log('[ui]', msg); } catch(_) {} };
  appendUi('Hindsight API ready');
      function initAutostartCheckbox() {
        const cb = document.getElementById('autostartToggle');
        if (!cb) return;
        window.hindsight.getAutostart().then(enabled => { cb.checked = !!enabled; }).catch(e=>{appendUi('autostart get failed: '+e);});
        cb.addEventListener('change', (e) => {
          window.hindsight.setAutostart(e.target.checked).then(() => { if (e.target.checked) doValidate(); }).catch(err=>{appendUi('setAutostart error: '+err);});
        });
      }

      // Collapse toggle utility
      function applyCollapseState(btn, body, key){
        const collapsed = localStorage.getItem(key) === '1';
        if (collapsed) { body.classList.add('collapsed'); btn.textContent='▸'; }
        else { body.classList.remove('collapsed'); btn.textContent='▾'; }
        btn.addEventListener('click', ()=>{
          const isCollapsed = body.classList.toggle('collapsed');
          btn.textContent = isCollapsed ? '▸' : '▾';
          localStorage.setItem(key, isCollapsed ? '1' : '0');
        });
      }
      // Initialize collapsible preference sections
      (function initCollapsibles(){
        const capBtn = document.getElementById('collapseCapture');
        const capBody = document.getElementById('capturePrefsBody');
        if (capBtn && capBody) applyCollapseState(capBtn, capBody, 'prefCollapse.capture');
        const secBtn = document.getElementById('collapseSecurity');
        const secBody = document.getElementById('securityPrefsBody');
        if (secBtn && secBody) applyCollapseState(secBtn, secBody, 'prefCollapse.security');
        const logBtn = document.getElementById('collapseLogSettings');
        const logBody = document.getElementById('logSettingsBody');
        if (logBtn && logBody) applyCollapseState(logBtn, logBody, 'prefCollapse.logSettings');
      })();

      // Load prefs (main page minimal subset)
  window.hindsight.getPrefs().then(p => {
        const qi = document.getElementById('intervalInput');
        const qd = document.getElementById('delayInput');
        if (qi) qi.value = p.interval || 5;
        if (qd) qd.value = p.delaySeconds || 0;
        // Prefs modal fields
        const pInt = document.getElementById('pInterval');
        const pDel = document.getElementById('pDelay');
        const pTz = document.getElementById('pLogTz');
        const pLevel = document.getElementById('pLogLevel');
        if (pInt) pInt.value = p.interval || 5;
        if (pDel) pDel.value = p.delaySeconds || 0;
  if (pTz) {
          // If custom offset not in list, add temporarily
          if (p.logTimezone && !Array.from(pTz.options).some(o=>o.value===p.logTimezone)) {
            const opt = document.createElement('option'); opt.value = p.logTimezone; opt.textContent = p.logTimezone + ' (custom)'; pTz.appendChild(opt);
          }
          pTz.value = p.logTimezone || 'LOCAL';
        }
        if (pLevel && p.logLevel) { try { pLevel.value = p.logLevel; } catch(_) {} }
  const dstCb = document.getElementById('pDstAdjust'); if (dstCb) dstCb.checked = !!p.dstAdjust;
        initAutostartCheckbox();
  }).catch(e=>{appendUi('prefs get failed: '+e);});
      // Populate common time zones (fixed offsets / notable)
      (function populateTimezones(){
        const tzSelect = document.getElementById('pLogTz');
        if (!tzSelect) return;
        // Preserve currently assigned value (from persisted prefs) before rebuilding list.
        const previous = tzSelect.value || null;
        const common = [
          ['LOCAL','LOCAL (system)'],
          ['UTC','UTC (+0000)'],
          ['-1100','-1100 (Pacific Midway)'],
          ['-1000','-1000 (Hawaii)'],
          ['-0900','-0900 (Alaska)'],
          ['-0800','-0800 (US Pacific)'],
          ['-0700','-0700 (US Mountain)'],
          ['-0600','-0600 (US Central)'],
          ['-0500','-0500 (US Eastern)'],
          ['-0400','-0400 (Atlantic / Carib)'],
          ['-0300','-0300 (Argentina / Brazil NE)'],
          ['-0200','-0200 (South Georgia)'],
          ['-0100','-0100 (Azores)'],
          ['+0000','+0000 (UTC duplicate)'],
          ['+0100','+0100 (Central Europe)'],
          ['+0200','+0200 (Eastern Europe / S. Africa)'],
          ['+0300','+0300 (Moscow / East Africa)'],
          ['+0330','+0330 (Iran)'],
          ['+0400','+0400 (Gulf)'],
          ['+0430','+0430 (Afghanistan)'],
          ['+0500','+0500 (Pakistan)'],
          ['+0530','+0530 (India)'],
          ['+0545','+0545 (Nepal)'],
          ['+0600','+0600 (Bangladesh)'],
          ['+0630','+0630 (Myanmar)'],
          ['+0700','+0700 (Indochina / WIB)'],
          ['+0800','+0800 (China / Singapore)'],
          ['+0830','+0830 (North Korea)'],
          ['+0900','+0900 (Japan / Korea)'],
          ['+0930','+0930 (Central Australia)'],
          ['+1000','+1000 (Eastern Australia)'],
          ['+1030','+1030 (Australia CDT alt)'],
          ['+1100','+1100 (Norfolk / Solomon)'],
          ['+1200','+1200 (NZ standard)'],
          ['+1245','+1245 (Chatham Islands)'],
          ['+1300','+1300 (NZ daylight / Tonga)'],
          ['+1400','+1400 (Line Islands)']
        ];
        // Clear and repopulate (always rebuild full known list)
        while (tzSelect.options.length) tzSelect.remove(0);
        for (const [val,label] of common) {
          const opt = document.createElement('option');
          opt.value = val; opt.textContent = label; tzSelect.appendChild(opt);
        }
        // If previous (persisted) value was a custom offset and not in common, re-add it.
        if (previous && !Array.from(tzSelect.options).some(o=>o.value === previous)) {
          const opt = document.createElement('option');
          opt.value = previous; opt.textContent = previous + ' (custom)';
          tzSelect.appendChild(opt);
        }
        if (previous) {
          try { tzSelect.value = previous; } catch(_) {}
        }
      })();

      // Preferences page navigation
      const pageMain = document.getElementById('pageMain');
      const pagePrefs = document.getElementById('pagePrefs');
      document.getElementById('openPrefs').addEventListener('click', ()=>{ pageMain.style.display='none'; document.getElementById('pageLogs').style.display='none'; pagePrefs.style.display='block'; });
      document.getElementById('closePrefs').addEventListener('click', ()=>{ pagePrefs.style.display='none'; pageMain.style.display='block'; });
      // Inject Logs button if not present
      (function ensureLogsButton(){
        if (!document.getElementById('openLogs')) {
          const btn = document.createElement('button'); btn.id='openLogs'; btn.textContent='Logs'; btn.style.float='right'; btn.style.fontSize='12px'; btn.style.marginLeft='6px';
          const h1 = document.querySelector('h1'); if (h1) { h1.appendChild(btn); }
          btn.addEventListener('click', ()=>{ pageMain.style.display='none'; pagePrefs.style.display='none'; document.getElementById('pageLogs').style.display='block'; });
        }
      })();
      document.getElementById('closeLogs').addEventListener('click', ()=>{ document.getElementById('pageLogs').style.display='none'; pageMain.style.display='block'; });
      // Save all prefs from dedicated page
      // Live timezone validation
      const tzSel = document.getElementById('pLogTz');
      const saveBtn = document.getElementById('saveAllPrefs');
      const saveMsg = document.getElementById('saveAllMsg');
      function validateTz(value) {
        const v = (value||'').trim().toUpperCase();
        if (v === 'LOCAL' || v === 'UTC') return {ok:true, norm:v};
        if (/^[+-]\d{4}$/.test(v)) return {ok:true, norm:v};
        if (/^[+-]\d{2}:\d{2}$/.test(v)) return {ok:true, norm:v.replace(':','')};
        return {ok:false, norm:null};
      }
      function applyTzValidation() {
        const {ok, norm} = validateTz(tzSel.value);
        if (!ok) {
          tzSel.style.borderColor = '#c00';
          saveBtn.disabled = true;
          saveMsg.textContent = 'Invalid timezone. Use LOCAL, UTC, or +HHMM/-HHMM.';
          saveMsg.style.color = '#c00';
        } else {
          tzSel.style.borderColor = '';
          saveBtn.disabled = false;
          saveMsg.textContent = '';
          saveMsg.style.color = '#444';
          // If user typed with colon and it's valid, update control to normalized form (without losing focus)
          if (norm && norm !== tzSel.value) tzSel.value = norm;
        }
      }
  if (tzSel) { tzSel.addEventListener('input', applyTzValidation); tzSel.addEventListener('change', applyTzValidation); applyTzValidation(); }

      document.getElementById('saveAllPrefs').addEventListener('click', ()=>{
        const interval = parseInt(document.getElementById('pInterval').value,10) || 5;
        const delaySeconds = parseInt(document.getElementById('pDelay').value,10) || 0;
        const msgEl = saveMsg;
        msgEl.textContent = 'Saving...'; msgEl.style.color = '#444';
        window.hindsight.setPrefs({interval, delaySeconds}).then(p => {
          msgEl.textContent = 'Saved.';
          // Reflect into main page quick prefs if legacy inputs still exist (older layout compatibility)
          const qi = document.getElementById('intervalInput');
          const qd = document.getElementById('delayInput');
          if (qi) qi.value = p.interval || interval;
          if (qd) qd.value = p.delaySeconds || delaySeconds;
        }).catch(err => { msgEl.textContent = 'Error: ' + err; msgEl.style.color = '#c00'; });
      });

      // Dedicated logging save button
      const saveLogBtn = document.getElementById('saveLogPrefs');
      const saveLogMsg = document.getElementById('saveLogMsg');
      if (saveLogBtn) {
        saveLogBtn.addEventListener('click', ()=>{
          const tzRaw = (tzSel && tzSel.value) || 'LOCAL';
          const {ok, norm} = validateTz(tzRaw);
          if (!ok) { if (saveLogMsg){ saveLogMsg.textContent='Invalid timezone'; saveLogMsg.style.color='#c66'; } return; }
          const dstAdjust = !!document.getElementById('pDstAdjust').checked;
          const logLevelSel = document.getElementById('pLogLevel');
          const logLevel = logLevelSel ? logLevelSel.value : 'INFO';
          if (saveLogMsg) { saveLogMsg.textContent='Saving...'; saveLogMsg.style.color='#888'; }
          window.hindsight.setPrefs({logTimezone: norm, dstAdjust, logLevel}).then(p=>{
            if (saveLogMsg){ saveLogMsg.textContent='Saved'; saveLogMsg.style.color='#4c4'; }
            try { updateTzPrefs(); } catch(_) {}
          }).catch(e=>{ if (saveLogMsg){ saveLogMsg.textContent='Error: '+e; saveLogMsg.style.color='#c66'; } });
        });
      }

      const savePrefsBtn = document.getElementById('savePrefsBtn');
      if (savePrefsBtn) {
        savePrefsBtn.addEventListener('click', () => {
          const interval = parseInt(document.getElementById('intervalInput').value, 10) || 5;
          const delaySeconds = parseInt(document.getElementById('delayInput').value, 10) || 0;
          const msgEl = document.getElementById('prefsMsg');
          if (msgEl) msgEl.textContent = 'Saving...';
          window.hindsight.setPrefs({interval, delaySeconds}).then(p => {
            if (msgEl) msgEl.textContent = 'Saved.';
            if (p.autostart) setTimeout(doValidate, 250);
          }).catch(err => { if (msgEl) msgEl.textContent = 'Error: ' + err; });
        });
      }

      function doValidate() {
        const wrap = document.getElementById('validation');
        const body = document.getElementById('validationBody');
        wrap.style.display = 'block';
        body.textContent = 'Validating...';
        window.hindsight.validateAutostart().then(res => {
      console.log('[validate] result', res);
          if (!res.exists) {
            body.textContent = 'Autostart file not found. (Enable autostart to generate)';
            if (document.getElementById('autostartToggle').checked) {
              setTimeout(() => {
        window.hindsight.validateAutostart().then(r2 => { console.log('[validate] retry', r2); if (r2.exists) doValidate(); }).catch(()=>{});
              }, 400);
            }
            return;
          }
            let out = 'File: ' + res.file + '\n';
            if (res.exec) out += 'Exec: ' + res.exec + '\n';
            if (!res.issues || res.issues.length === 0) out += '\nStatus: OK';
            else out += '\nIssues:\n - ' + res.issues.join('\n - ');
            body.textContent = out;
        }).catch(err => {
          console.error('[validate] error', err);
          body.textContent = 'Validation error: ' + (err && err.message ? err.message : err);
        });
      }
      window.doValidate = doValidate; // expose for console debugging
      const valBtn = document.getElementById('validateBtn');
      if (valBtn) {
        valBtn.addEventListener('click', doValidate);
        setTimeout(()=>{ if (document.getElementById('autostartToggle')?.checked) doValidate(); }, 600);
      }

      let lastStatusTime = null;
      let lastIntervalSeconds = 5; // default, updated from prefs
      window.hindsight.getPrefs().then(p=>{ if (p && p.interval) lastIntervalSeconds = p.interval; }).catch(()=>{});
      let lastBackend = null;
      let lastSwitchReason = null;
      let lastSwitchLocalTs = null;
      window.hindsight.onStatus((s) => {
        lastStatusTime = Date.now();
        if (s.interval) lastIntervalSeconds = s.interval; // if backend includes
        const statusEl = document.getElementById('status');
        let localStr = s.last_capture_utc;
        try { localStr = new Date(s.last_capture_utc).toLocaleString(); } catch(_) {}
  statusEl.textContent = `Last capture (local): ${localStr} | Window: ${s.window_title} | Count: ${s.capture_count}`;
        const warn = document.getElementById('staleWarning');
        warn.style.display = 'none';
        const errEl = document.getElementById('errorDisplay');
        if (s.error) {
          errEl.textContent = 'Error: ' + s.error;
        } else {
          errEl.textContent = '';
        }
        // Backend / switch reason surfacing
        const backendInfoEl = document.getElementById('backendInfo');
        let changed = false;
        if (s.capture_backend && s.capture_backend !== lastBackend) {
          changed = true;
        }
        if (s.backend_switch_reason) {
          lastSwitchReason = s.backend_switch_reason;
          lastSwitchLocalTs = Date.now();
        }
        if (s.capture_backend || lastSwitchReason) {
          backendInfoEl.style.display = 'block';
          const parts = [];
          if (s.capture_backend) parts.push('Backend: ' + s.capture_backend);
          if (lastSwitchReason) {
            let when = '';
            if (lastSwitchLocalTs) when = ' at ' + new Date(lastSwitchLocalTs).toLocaleTimeString();
            parts.push('Last switch reason: ' + lastSwitchReason + when);
          }
          backendInfoEl.textContent = parts.join(' | ');
        }
        if (s.capture_backend) lastBackend = s.capture_backend;
      });
  window.hindsight.onLog((msg) => { appendUi('log '+msg); });
      // Python log streaming: checkbox level filters + ring buffer
      ;(function unifiedLogInit(){
        const view = document.getElementById('pyLogView'); if (!view) return;
        const stats = document.getElementById('pyLogStats');
        const clearBtn = document.getElementById('pyLogClear');
        const BUF_MAX = 500; const buf = []; // {level,line,src}
        function enabled(){ const m={}; document.querySelectorAll('.lvChk').forEach(cb=>{ m[cb.getAttribute('data-level')] = cb.checked; }); return m; }
  function updateStats(){ const c={TRACE:0,DEBUG:0,INFO:0,WARNING:0,ERROR:0,CRITICAL:0}; for (const b of buf) c[b.level] = (c[b.level]||0)+1; stats.textContent = `Buffered ${buf.length}/${BUF_MAX}  T:${c.TRACE} D:${c.DEBUG} I:${c.INFO} W:${c.WARNING} E:${c.ERROR} C:${c.CRITICAL}`; }
  function esc(s){ return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  function renderLine(entry){ return `<span class="log-line log-level-${entry.level}">${esc(entry.line)}</span>`; }
  function rebuild(){ const en=enabled(); const stick=(view.scrollTop+view.clientHeight+40)>=view.scrollHeight; const html = buf.filter(b=>en[b.level]).map(renderLine).join(''); view.innerHTML = html; if (stick) view.scrollTop=view.scrollHeight; updateStats(); }
        // Backend timezone spec aware timestamp (mirrors main.js tz logic subset)
        let _logTzSpec = 'LOCAL';
        let _dstAdjust = false;
        try { window.hindsight.getPrefs().then(p=>{ if(p){ _logTzSpec = p.logTimezone||'LOCAL'; _dstAdjust = !!p.dstAdjust; }}).catch(()=>{}); } catch(_) {}
        function updateTzPrefs(){ try { window.hindsight.getPrefs().then(p=>{ if(p){ _logTzSpec = p.logTimezone||'LOCAL'; _dstAdjust = !!p.dstAdjust; }}).catch(()=>{}); } catch(_) {} }
        function backendStamp(){
          const spec = (_logTzSpec||'LOCAL').toUpperCase();
          const now = new Date();
            const pad = (n,l=2)=> String(n).padStart(l,'0');
          let year,mon,day,hr,min,sec,ms,offSign,offH,offM; const dstAdd = _dstAdjust?1:0;
          if (spec === 'UTC') {
            year=now.getUTCFullYear(); mon=pad(now.getUTCMonth()+1); day=pad(now.getUTCDate());
            hr=pad((now.getUTCHours()+dstAdd)%24); min=pad(now.getUTCMinutes()); sec=pad(now.getUTCSeconds()); ms=pad(now.getUTCMilliseconds(),3);
            offSign='+'; offH='00'; offM='00';
          } else if (/^[+-]\d{4}$/.test(spec)) {
            const sign = spec[0] === '-' ? -1 : 1; const h=parseInt(spec.slice(1,3),10); const m=parseInt(spec.slice(3,5),10);
            let total = sign*(h*60+m); if (dstAdd) total += 60; const shifted = new Date(now.getTime()+ total*60000);
            year=shifted.getUTCFullYear(); mon=pad(shifted.getUTCMonth()+1); day=pad(shifted.getUTCDate());
            hr=pad(shifted.getUTCHours()); min=pad(shifted.getUTCMinutes()); sec=pad(shifted.getUTCSeconds()); ms=pad(shifted.getUTCMilliseconds(),3);
            const absMin=Math.abs(total); offSign= total<=0?'-':'+'; offH=pad(Math.floor(absMin/60)); offM=pad(absMin%60);
          } else {
            year=now.getFullYear(); mon=pad(now.getMonth()+1); day=pad(now.getDate());
            hr=pad((now.getHours()+dstAdd)%24); min=pad(now.getMinutes()); sec=pad(now.getSeconds()); ms=pad(now.getMilliseconds(),3);
            const off=now.getTimezoneOffset(); const sign = off<=0?'+':'-'; const abs=Math.abs(off); offSign=sign; offH=pad(Math.floor(abs/60)); offM=pad(abs%60);
          }
          let abbr='';
          try {
            if (spec === 'UTC') abbr='UTC';
            else if (/^[+-]\d{4}$/.test(spec)) {
              const stdMap={ '-0800':'PST','-0700':'MST','-0600':'CST','-0500':'EST','-0400':'AST','+0000':'UTC','+0100':'CET','+0200':'EET'};
              const dstMap={ '-0800':'PDT','-0700':'MDT','-0600':'CDT','-0500':'EDT','-0400':'ADT','+0100':'CEST','+0200':'EEST'};
              const norm=spec; if (_dstAdjust && dstMap[norm]) abbr=dstMap[norm]; else if (stdMap[norm]) abbr=stdMap[norm]; if(!abbr) abbr='UTC'+offSign+offH+(offM!=='00'?(':'+offM):'');
            } else if (spec === 'LOCAL') {
              try { const fmt=new Intl.DateTimeFormat(undefined,{timeZoneName:'short'}); const parts=fmt.formatToParts(now); const tzp=parts.find(p=>p.type==='timeZoneName'); if(tzp) abbr=tzp.value.toUpperCase(); } catch(_) {}
            }
          } catch(_) {}
          return `${year}-${mon}-${day}T${hr}:${min}:${sec}.${ms}${offSign}${offH}:${offM}${abbr?(' '+abbr):''}`;
        }
  // Ingest a log line, normalizing to: [timestamp] [LEVEL] original_line_without_leading_level
  function ingest(line, level, src){
    if(!line) return;
    const clean = line.replace(/\x1b\[[0-9;]*m/g,''); // strip ANSI color codes
    const lvl = (level||'INFO').toUpperCase();
    // Remove any existing leading explicit level token to avoid duplication after timestamp.
    const withoutLeadingLevel = clean.replace(/^\[(DEBUG|INFO|WARNING|ERROR|CRITICAL)\]\s*/i,'');
    const stamped = `[${backendStamp()}] [${lvl}] ${withoutLeadingLevel}`;
    buf.push({level:lvl,line:stamped,src:src||'py'});
    if(buf.length>BUF_MAX) buf.splice(0, buf.length-BUF_MAX);
    const en=enabled();
    if(en[lvl]) {
      const stick=(view.scrollTop+view.clientHeight+40)>=view.scrollHeight;
      const spanHtml = `<span class="log-line log-level-${lvl}">${esc(stamped)}</span>`;
      // Append without adding literal newlines; spans are block-level and handle line breaks.
      view.innerHTML += spanHtml;
      if(stick) view.scrollTop=view.scrollHeight;
    }
    updateStats();
  }
        clearBtn.addEventListener('click', ()=>{ buf.length=0; rebuild(); });
        const simBtn = document.getElementById('simLog');
        if (simBtn) {
          simBtn.addEventListener('click', ()=>{
            // Emit one sample entry for each level for visual testing
            ingest('Simulated TRACE message for testing colors', 'TRACE', 'sim');
            ingest('Simulated DEBUG message for testing colors', 'DEBUG', 'sim');
            ingest('Simulated INFO message for testing colors', 'INFO', 'sim');
            ingest('Simulated WARNING message for testing colors', 'WARNING', 'sim');
            ingest('Simulated ERROR message for testing colors', 'ERROR', 'sim');
            ingest('Simulated CRITICAL message for testing colors', 'CRITICAL', 'sim');
            updateStats();
          });
        }
        document.querySelectorAll('.lvChk').forEach(cb=> cb.addEventListener('change', rebuild));
        // Python backend log lines
        window.hindsight.onPyLog(pl=>{ if(!pl||!pl.line) return; ingest(pl.line, pl.level||'INFO', 'py'); });
        // Frontend supervision log lines for capture/duplicate/heartbeat categories
        window.hindsight.onLog(line => {
          if (!line) return;
          if (!/^\[[^\]]+\]/.test(line)) return; // require leading [category]
          // If explicit level token present at start, trust it.
          const explicit = line.match(/^\[(DEBUG|INFO|WARNING|ERROR|CRITICAL)\]\s*/i);
          let level = null;
          let rest = line;
          if (explicit) {
            level = explicit[1].toUpperCase();
            rest = line.replace(/^\[[^\]]+\]\s*/, '');
          }
          if (!level) {
            const catMatch = line.match(/^\[([a-z0-9_-]+)\]/i);
            const cat = catMatch ? catMatch[1].toLowerCase() : '';
            switch (cat) {
              case 'error': level = 'ERROR'; break;
              case 'anomaly':
              case 'health':
              case 'stale': level = 'WARNING'; break;
              case 'duplicate':
              case 'heartbeat':
              case 'tz': level = 'DEBUG'; break;
              case 'trace': level = 'TRACE'; break;
              case 'auth': level = /failed|locked/i.test(line) ? 'WARNING' : 'INFO'; break;
              default: level = 'INFO';
            }
          }
          ingest(line, level, 'fe');
        });
        updateStats();
      })();
      // Staleness checker: warn if no status within 3 * interval (min 10s grace)
      function checkStale() {
        const warn = document.getElementById('staleWarning');
        const now = Date.now();
        const thresholdMs = Math.max(10000, (lastIntervalSeconds||5) * 3000); // 3*interval*1000
        if (!lastStatusTime) {
          // After initial grace period, show warning if still nothing
          if (now > thresholdMs + performance.timing.navigationStart) {
            warn.textContent = 'Status stale: no capture data received yet.';
            warn.style.display = 'block';
          }
        } else if ((now - lastStatusTime) > thresholdMs) {
          const age = ((now - lastStatusTime)/1000).toFixed(1);
            warn.textContent = `Status stale: last update ${age}s ago (threshold ${(thresholdMs/1000).toFixed(0)}s).`;
            warn.style.display = 'block';
        } else {
          warn.style.display = 'none';
        }
        setTimeout(checkStale, 4000);
      }
      setTimeout(checkStale, 6000);
      // Buttons
      document.getElementById('btnStart').addEventListener('click', ()=>{
        const btn = document.getElementById('btnStart');
        if (btn.dataset.lock === '1') return; // debounce
        btn.dataset.lock = '1';
        btn.disabled = true;
        window.hindsight.captureStart().then(r=>{ 
          document.getElementById('pidDisplay').textContent = (r && r.action==='already') ? 'Already running' : 'Starting...';
          setTimeout(refreshPid,700);
        }).finally(()=>{
          setTimeout(()=>{ btn.dataset.lock=''; btn.disabled=false; }, 1500);
        });
      });
      document.getElementById('btnStop').addEventListener('click', ()=>{
        window.hindsight.captureStop().then(()=>{ setTimeout(refreshPid,700);});
      });
      document.getElementById('btnPid').addEventListener('click', refreshPid);
      document.getElementById('btnPurge').addEventListener('click', ()=>{
        if (!confirm('Delete all stored capture data (encrypted + plaintext artifacts)?')) return;
        window.hindsight.purgeData().then(r=>{
          appendUi('Purge removed '+(r.removed||0)+' items');
          setTimeout(refreshPid, 500);
  }).catch(e=>{ appendUi('Purge error: '+e); });
      });
      function refreshPid(){
        window.hindsight.captureStatus().then(r=>{
          document.getElementById('pidDisplay').textContent = r.pid ? ('PID: '+r.pid) : 'Not running';
        });
      }
      setInterval(refreshPid, 5000);
      refreshPid();

      // Change secret logic
      const secBtn = document.getElementById('secChangeBtn');
      const secMsg = document.getElementById('secMsg');
      function isPin(val){ return /^\d{4,8}$/.test(val); }
      function passOk(val){ return val.length>=12 && /[A-Z]/.test(val) && /[a-z]/.test(val) && /\d/.test(val) && /[^A-Za-z0-9\s]/.test(val) && !/\s/.test(val); }
      secBtn.addEventListener('click', ()=>{
        const cur = document.getElementById('secCurrent').value.trim();
        const n1 = document.getElementById('secNew').value;
        const n2 = document.getElementById('secNew2').value;
        const useRec = document.getElementById('secUseRecovery').checked;
        secMsg.style.color = '#444';
        if (!cur || !n1 || !n2) { secMsg.textContent='Fill all fields'; secMsg.style.color='#c00'; return; }
        if (n1 !== n2) { secMsg.textContent='New secrets mismatch'; secMsg.style.color='#c00'; return; }
        if (!(isPin(n1) || passOk(n1))) { secMsg.textContent='New secret fails complexity'; secMsg.style.color='#c00'; return; }
        secMsg.textContent='Changing...';
        window.hindsight.changeSecret(cur, n1, useRec).then(r=>{
          if (r && r.ok) {
            secMsg.textContent='Changed.'; secMsg.style.color='#080';
            document.getElementById('secNew').value='';
            document.getElementById('secNew2').value='';
          } else {
            secMsg.textContent='Error: '+ (r && (r.err||r.code) || 'unknown'); secMsg.style.color='#c00';
          }
        }).catch(e=>{ secMsg.textContent='Error: '+e; secMsg.style.color='#c00'; });
      });
    })();
  </script>
</body>
</html>
